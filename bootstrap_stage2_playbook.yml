---

- name: Bootstrap stage 2 (by ansible automation user)
  hosts: bootstrap_stage_2
  vars_files: bootstrap_stage2_vault_encrypted.yml
  become: true
 
  tasks:
    - name: Install avahi-daemon on Debian system
      ansible.builtin.package:
        update_cache: true
        name:
          - avahi-daemon
        state: present
      when: ansible_os_family == "Debian"

    - name: Install avahi Redhat system
      ansible.builtin.package:
        update_cache: true
        name:
          - avahi
        state: present
      when: ansible_os_family == "RedHat"


    - name: Enable and run avahi
      ansible.builtin.service:
        name: avahi-daemon.service
        enabled: true
        state: started

    - name: Install python3 firewall library
      ansible.builtin.package:
        update_cache: true
        name:
          - python3-firewall
        state: present
      when: ansible_os_family == "RedHat"


    - name: Allow mdns through the firewall
      ansible.posix.firewalld:
        service: mdns
        state: enabled
