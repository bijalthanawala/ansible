---

- name: Bootstrap stage 2 (by ansible automation user)
  hosts: bootstrap_stage_2
  vars_files: bootstrap_stage2_vault_encrypted.yml
  become: true
 
  tasks:
    - name: Update package cache
      ansible.builtin.package:
        update_cache: true

    - name: Install avahi-daemon on Debian system
      ansible.builtin.package:
        name:
          - avahi-daemon
        state: present
      when: ansible_os_family == "Debian"

    - name: Install avahi on Redhat system
      ansible.builtin.package:
        name:
          - avahi
        state: present
      when: ansible_os_family == "RedHat"


    - name: Enable and run avahi
      ansible.builtin.service:
        name: avahi-daemon.service
        enabled: true
        state: started

    - name: Get the package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Get the service facts
      ansible.builtin.service_facts:
      when: ansible_os_family == "RedHat"


    - block:
      - name: Install python3 firewall library on Redhat system
        ansible.builtin.package:
          name:
            - python3-firewall
          state: present

      - name: Allow mdns through firewall on Redhat system
        ansible.posix.firewalld:
          service: mdns
          state: enabled
      when: >
        ansible_os_family == "RedHat" and
        'firewalld' in ansible_facts.packages and
        ansible_facts.services['firewalld.service'].state == "running"

    - name: run ufw
      command: ufw status
      register: ufw_output
      when: ansible_os_family == "Debian" and 'ufw' in ansible_facts.packages

    - name: Allow mdns through firewall on Debian system
      # ufw service is a one-shot service to turn on the firewall,
      # hence it does not continue to run.
      # Use ufw command output to confirm the firewall state
      community.general.ufw:
        proto: udp
        port: 5353
        rule: allow
      when: >
        ansible_os_family == "Debian" and
        'ufw' in ansible_facts.packages and
        'Status: active' in ufw_output.stdout