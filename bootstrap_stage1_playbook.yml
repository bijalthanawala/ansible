---

- name: prepare new hosts for ansible automation
  hosts: bootstrap
  vars_files: bootstrap_stage1_vault_encrypted.yml
  become: true


  tasks:
    - name: create ansible automation user
      ansible.builtin.user:
        name: "{{ ansible_automation_user }}"
        state: present
        create_home: true
        password: $6$dtfj/z.ivsu$pcLKADHR5HbSkXxYvD/22BUr6mfix1R.B2rhj4tpLTk2CQR8mnzXCwosEGehqpsg/BVKNOpSy.OVZ0WZ4CdFT1

    - name: Add ansible automation user to the sudo group
      ansible.builtin.user:
        name: "{{ ansible_automation_user }}"
        groups: sudo
        append: true
      when: ansible_os_family == "Debian"

    - name: Add ansible automation user to the wheel group
      ansible.builtin.user:
        name: "{{ ansible_automation_user }}"
        groups: wheel
        append: true
      when: ansible_os_family == "RedHat"

    - name: copy ssh public key to the host
      ansible.posix.authorized_key:
        state: present
        user: "{{ ansible_automation_user }}"
        key: "{{ lookup('file', lookup('env', 'HOME') + '/.ssh/id_rsa_ansible_automation.pub') }}"